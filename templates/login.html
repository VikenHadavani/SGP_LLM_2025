<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ImageInsight AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card" id="loginCard">
            <h2 class="auth-title">Welcome Back!</h2>
            <p class="auth-subtitle">Log in to access your account</p>
            <form method="POST" action="/login" class="auth-form">
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email" name="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
            </form>
            <p class="auth-footer">
                Don't have an account? <a href="/signup">Sign up</a>
            </p>
            <button onclick="googleSignIn()" class="google-signin-btn">
                <img src="/static/google-logo.png" alt="Google logo">
                Sign in with Google
            </button>
        </div>

        <!-- 2FA Verification Card (hidden by default) -->
        <div class="auth-card" id="verificationCard" style="display: none;">
            <h2 class="auth-title">Two-Factor Authentication</h2>
            <p class="auth-subtitle">Enter the verification code sent to your email</p>
            <div class="form-group">
                <label for="mfaVerificationCode"><i class="fas fa-shield-alt"></i> Verification Code</label>
                <input type="text" id="mfaVerificationCode" placeholder="Enter 6-digit code" maxlength="6">
            </div>
            <button onclick="verifyMFA()" class="auth-btn">Verify</button>
            <button onclick="resendCode()" class="auth-btn secondary">Resend Code</button>
            <button onclick="cancelMFA()" class="auth-btn secondary">Cancel</button>
        </div>
    </div>

    <!-- Add this modal after the login form -->
    <div id="verificationModal" class="modal">
        <div class="modal-content">
            <h2>Verify Your Account</h2>
            <p>We've sent a verification code to your email. Please enter it below:</p>
            <form id="verificationForm">
                <div class="form-group">
                    <input type="text" id="modalVerificationCode" placeholder="Enter verification code" required>
                </div>
                <button type="submit" class="btn">Verify</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "{{ config.FIREBASE_API_KEY }}",
            authDomain: "{{ config.FIREBASE_AUTH_DOMAIN }}",
            projectId: "{{ config.FIREBASE_PROJECT_ID }}",
            storageBucket: "{{ config.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "{{ config.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "{{ config.FIREBASE_APP_ID }}",
            databaseURL: "https://{{ config.FIREBASE_PROJECT_ID }}.firebaseio.com"
        };

        console.log("Initializing Firebase with config:", firebaseConfig);
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let confirmationResult = null;

        // Handle verification form submission
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = document.getElementById('modalVerificationCode').value;
            const email = sessionStorage.getItem('pendingVerificationEmail');
            
            if (!code || !email) {
                alert('Please enter the verification code');
                return;
            }
            
            console.log('Submitting verification code:', code);
            console.log('For email:', email);
            
            fetch('/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Verification response:', data);
                if (data.success) {
                    hideVerificationModal();
                    window.location.href = '/';
                } else {
                    alert(data.message || 'Invalid verification code');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during verification');
            });
        });

        // Update the Google Sign-In success handler
        function handleGoogleSignInSuccess(data) {
            console.log('Handling sign-in success:', data);
            if (data.needs_verification) {
                // Show verification modal
                showVerificationModal();
                // Store email for verification
                sessionStorage.setItem('pendingVerificationEmail', data.email);
            } else if (data.success) {
                window.location.href = '/';
            } else {
                alert(data.message);
            }
        }

        // Google Sign In with MFA
        function googleSignIn() {
            console.log("Google Sign In clicked");
            const provider = new firebase.auth.GoogleAuthProvider();
            
            console.log("Created Google Auth Provider");
            
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            console.log("Set custom parameters");
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log("Sign in successful:", result);
                    
                    // Check if MFA is required
                    if (result.user.multiFactor && result.user.multiFactor.enrolledFactors.length > 0) {
                        console.log("MFA required");
                        // Show MFA verification card
                        showVerificationCard();
                        
                        // Get the multi-factor session
                        return result.user.multiFactor.getSession();
                    } else {
                        console.log("No MFA required, getting ID token");
                        // No MFA required, proceed with normal login
                        return result.user.getIdToken();
                    }
                })
                .then((sessionOrToken) => {
                    console.log("Received sessionOrToken:", typeof sessionOrToken);
                    if (typeof sessionOrToken === 'string') {
                        console.log("Sending ID token to backend");
                        // This is a token (no MFA required)
                        return fetch('/google-signin', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ idToken: sessionOrToken })
                        });
                    } else {
                        console.log("Storing MFA session");
                        // This is a session (MFA required)
                        const session = sessionOrToken;
                        // Store the session for verification
                        confirmationResult = session;
                        return Promise.resolve();
                    }
                })
                .then(response => {
                    if (response) {
                        console.log("Received response from backend");
                        return response.json();
                    }
                })
                .then(data => {
                    console.log("Processed response data:", data);
                    handleGoogleSignInSuccess(data);
                })
                .catch(error => {
                    console.error("Error during sign in:", error);
                    alert('Login failed: ' + error.message);
                });
        }

        // Handle 2FA
        function showVerificationCard() {
            document.getElementById('loginCard').style.display = 'none';
            document.getElementById('verificationCard').style.display = 'block';
        }

        function showLoginCard() {
            document.getElementById('verificationCard').style.display = 'none';
            document.getElementById('loginCard').style.display = 'block';
        }

        // Handle MFA verification
        function verifyMFA() {
            const code = document.getElementById('mfaVerificationCode').value;
            if (!code) {
                alert('Please enter the verification code');
                return;
            }

            if (!confirmationResult) {
                alert('No verification session found. Please try signing in again.');
                return;
            }

            confirmationResult.confirm(code)
                .then((result) => {
                    console.log("MFA verification successful:", result);
                    return result.user.getIdToken();
                })
                .then((idToken) => {
                    return fetch('/google-signin', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ idToken: idToken })
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    } else {
                        alert('Verification failed: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error("Verification error:", error);
                    alert('Verification failed: ' + error.message);
                });
        }

        function resendCode() {
            if (confirmationResult) {
                confirmationResult.confirm()
                    .then(() => {
                        alert('New code sent successfully');
                    })
                    .catch(error => {
                        console.error("Resend error:", error);
                        alert('Failed to resend code: ' + error.message);
                    });
            }
        }

        function cancelMFA() {
            showLoginCard();
            confirmationResult = null;
        }

        // Add these functions to handle verification
        function showVerificationModal() {
            document.getElementById('verificationModal').style.display = 'block';
        }

        function hideVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
        }
    </script>

    <style>
        /* Add these styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: #666;
        }

        /* ... existing styles ... */
    </style>
</body>
</html>